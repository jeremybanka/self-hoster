name: Integration

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize]

jobs:
  setup:
    name: Startup 
    runs-on: ubuntu-latest
    steps:
      - name: Get Zsh
        run: sudo apt install zsh

      - name: Checkout
        uses: actions/checkout@v4

      - run: ./scripts/setup.sh
      - run: ./scripts/setup.sh

      - name: Start
        run: |
          source ~/.zshrc
          cp .env.defaults .env
          timeout 3s nr start || true
          if ! grep -q "tempest.games::frontend: ðŸ’¬ alive" logs/flightdeck.jsonl; then
            echo "ðŸš¨ tempest.games::frontend did not start up in time"
            cat logs/flightdeck.jsonl
            exit 1
          fi
          if ! grep -q "tempest.games::backend: ðŸ’¬ alive" logs/flightdeck.jsonl; then
            echo "ðŸš¨ tempest.games::backend did not start up in time"
            cat logs/flightdeck.jsonl
            exit 1
          fi
        shell: zsh {0}
